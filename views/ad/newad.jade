extends ../layout

block content
  h1 Ad Edit


  div
      h1 User information
      table
          tr
            td
              p Name:
            td
              h5 #{user.name}
          tr
            td
              p Email:
            td
              h5 #{user.email}
          tr
            td
              p Telephone:
            td
              h5 #{user.telephone}

      form(name='adForm', action='#{formAction}', method='post', onsubmit='event.preventDefault(); return validateForm()', enctype='multipart/form-data')
         h1 Item information
         if message.length > 0
             div.msg
                 p #{message}
         table
              tr
                td(colspan=2)
                  p.small#validator1(align='right')
              tr
                td
                  p Category:
                td
                   if category
                       h5 #{category.name}
                   else
                       select#select(name='category')
                           option(value='') select category
                           each category, i in categories
                               option(value='#{category._id}') #{category.name}
         table
              tr
                td(colspan=2)
                  p.small#validator2(align='right')
              tr
                td
                  p Title:
                td
                  input.title(type='text', value='#{ad.title}', name='adtitle', maxlength=60, size=37)
         p Description:
         textarea(name='addescription', rows=10, cols=40) #{ad.description}
         p Price:
           input(type='text', value='#{ad.price}', name='adprice')


         p Photos:
           table
               tr
                 td.img
                   div.fileUpload
                     input.upload(type='file', name='photo1', accept='image/*', onchange='openPhoto(event)')
                     img#photo1(src=(ad.image1 !== undefined ? '/images/#{ad.image1}' : '/images/logo/camera.png'), width=150)
                 td.img
                   div.fileUpload
                     input.upload(type='file', name='photo2', accept='image/*', onchange='openPhoto(event)')
                     img#photo2(src=(ad.image2 !== undefined ? '/images/#{ad.image2}' : '/images/logo/camera.png'), width=150)
               tr
                 td
                   if ad.image1
                     div.delete(align='center')
                        a.img(href='/ads/#{ad._id}/imgdel?img=#{ad.image1}&id=link1') delete
                   else
                     p.img#PARphoto1(onclick="delImage('photo1')", align='center') delete
                 td
                   if ad.image2
                     div.delete(align='center')
                        a.img(href='/ads/#{ad._id}/imgdel?img=#{ad.image2}&id=link2', align='center') delete
                   else
                     p.img#PARphoto2(onclick="delImage('photo2')", align='center') delete

         div.invCaptcha
           p.small#validator3(align='right')
           div.captcha#captcha
             table
               tr
                 td
                     img(src='data:image/jpeg;base64, #{captcha}')
                 td
                     input.captcha(type='text', name='captcha', maxlength=4)


          button(type='submit') Save

  script(type='text/javascript').
      var delImage = function (name) {
          document.getElementById(name).getAttributeNode('src').value='/images/logo/camera.png';
          document.getElementsByName(name)[0].value='';
          document.getElementById('PAR' + name).style.visibility='hidden';
      } ;

  script(type='text/javascript').
      var openPhoto = function (event) {
          var input = event.target;
          var reader = new FileReader();
          reader.onload = function () {
              var dataURL = reader.result;
              var output = document.getElementById(input.name);
              output.src = dataURL;
          };
          reader.readAsDataURL(input.files[0]);
          document.getElementById('PAR' + input.name).style.visibility='visible';
      };

  script(type='text/javascript', src='/javascripts/validator.min.js').
  script(type = 'text/javascript').
      function validateForm() {
          var form = document.forms['adForm'];
          var captcha = form['captcha'];
          var isValid = true;
          if (!captcha.value)  {
              captcha.focus();
              document.getElementById('validator3').innerHTML = 'You didn\'t enter code';
              document.getElementById('captcha').style.border = "solid LightSalmon";
              isValid = false;
          }
          var title = form['adtitle'];
          if (!title.value)  {
              title.focus();
              document.getElementById('validator2').innerHTML = 'You didn\'t enter title';
              title.style.border = "solid LightSalmon";
              isValid = false;
          }
          var category = form['category'];
          if (!validator.isMongoId(category.value)) {
              category.focus();
              document.getElementById('validator1').innerHTML = 'You didn\'t select category';
              category.style.border = "solid LightSalmon";
              isValid = false;
          }

          return isValid ? form.submit() : false;
      }
